# ✅ Реализована интеграция Claude + MCP через Tool Use API

## 🎯 Что было сделано

Реализована **правильная интеграция** Claude с Yandex Tracker через Tool Use API вместо ручной проверки ключевых слов.

---

## 📝 Проблемы, которые были решены

### 1. ❌ Claude упоминал Yandex Tracker в каждом ответе

**Проблема:**
- System prompt всегда содержал "Вы - полезный ассистент с доступом к инструментам Yandex Tracker"
- Даже когда Tracker не был настроен или вопрос был об ином
- Claude думал о Tracker в каждом ответе

**Решение:**
- System prompt теперь **динамический**
- Упоминает Tracker **только** когда он настроен и подключен
- Для обычных вопросов - обычный system prompt

### 2. ❌ Двойные ответы (Claude + Tracker)

**Проблема:**
- При запросе о задачах появлялось два ответа
- Один от Claude ("У меня нет доступа")
- Второй от Tracker (правильная статистика)

**Решение:**
- Убрана ручная проверка ключевых слов (`isYandexTrackerCommand`)
- Все запросы идут Claude
- Claude сам решает, когда вызывать MCP инструменты

### 3. ❌ Ручная проверка ключевых слов

**Было:**
```swift
if isYandexTrackerCommand(messageToSend) {
    handleYandexTrackerCommand(messageToSend)
    return
}
sendToClaude(message: messageToSend)
```

**Стало:**
```swift
// Все сообщения идут Claude с инструментами (если настроены)
sendToClaude(message: messageToSend)
```

---

## 🏗️ Архитектура решения

### Новые компоненты:

1. **ClaudeTool.swift** - Модели для Tool Use API
   - `ClaudeTool` - определение инструмента
   - `ClaudeToolResponse` - ответ с tool_use
   - `ToolResult` - результат выполнения инструмента

2. **YandexTrackerTools.swift** - Определения инструментов
   - `get_yandex_tracker_stats` - статистика задач
   - `get_yandex_tracker_issues` - список задач
   - `get_yandex_tracker_issue` - конкретная задача

3. **Изменения в ChatViewModel.swift:**
   - Динамический system prompt (строки 434-451)
   - Добавление инструментов в запрос (строки 469-489)
   - Обработка tool_use ответов (строки 725-795)
   - Отправка результатов обратно Claude (строки 797-914)

---

## 🔄 Как это работает теперь

### Поток обработки запроса:

```
┌─────────────────────────────────────────────────────────────┐
│ Пользователь: "Сколько открытых задач?"                    │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  │ ВСЕ запросы идут Claude!
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ ChatViewModel.sendToClaudeDirectly()                        │
│                                                             │
│ if isYandexTrackerConfigured && isConnected {              │
│     requestBody["tools"] = YandexTrackerToolsProvider      │
│     systemPrompt = "...с доступом к Yandex Tracker"        │
│ } else {                                                    │
│     // Нет tools                                            │
│     systemPrompt = "Вы - полезный ассистент"               │
│ }                                                           │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ Claude API                                                  │
│                                                             │
│ System: "Вы - полезный ассистент с доступом к Yandex       │
│          Tracker. Когда пользователь спрашивает о задачах, │
│          используйте доступные инструменты."               │
│                                                             │
│ Tools: [get_yandex_tracker_stats, ...]                     │
│                                                             │
│ Message: "Сколько открытых задач?"                         │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  │ Claude анализирует
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ Claude думает:                                              │
│ "Пользователь спрашивает о задачах.                        │
│  У меня есть инструмент get_yandex_tracker_stats.          │
│  Использую его!"                                            │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  │ Claude возвращает tool_use
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ Response:                                                   │
│ {                                                           │
│   "stop_reason": "tool_use",                                │
│   "content": [                                              │
│     {                                                       │
│       "type": "tool_use",                                   │
│       "id": "toolu_123",                                    │
│       "name": "get_yandex_tracker_stats",                   │
│       "input": { "filter": null }                           │
│     }                                                       │
│   ]                                                         │
│ }                                                           │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ ChatViewModel.handleToolUse()                               │
│                                                             │
│ Извлекаем: name = "get_yandex_tracker_stats"               │
│           input = { "filter": null }                       │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ YandexTrackerToolsProvider.executeTool()                   │
│                                                             │
│ executeGetStats(input, trackerService)                     │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ YandexTrackerService.getIssueStats()                       │
│                                                             │
│ → MCP Server → Yandex Tracker API                          │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  │ JSON результат
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ Результат:                                                  │
│ {                                                           │
│   "total": 42,                                              │
│   "open": 10,                                               │
│   "in_progress": 8,                                         │
│   "closed": 24,                                             │
│   "by_status": { ... }                                      │
│ }                                                           │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ ChatViewModel.sendToolResultsToClaude()                     │
│                                                             │
│ Отправляем результат обратно Claude с контекстом           │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ Claude API (второй запрос)                                  │
│                                                             │
│ Message: "Пользователь спросил: 'Сколько открытых задач?'  │
│           Результат выполнения инструмента:                 │
│           { total: 42, open: 10, ... }"                     │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  │ Claude форматирует ответ
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ Claude отвечает:                                            │
│                                                             │
│ "Анализирую ваш Yandex Tracker:                             │
│                                                             │
│  У вас сейчас 42 задачи, из которых:                        │
│  • 10 открытых (нужно взять в работу)                       │
│  • 8 в процессе выполнения                                  │
│  • 24 уже закрыты                                           │
│                                                             │
│  Прогресс хороший - 57% задач завершено!"                   │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ Пользователь видит естественный ответ                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 📋 Изменения в коде

### 1. ChatViewModel.swift (строки 434-451)

**Было:**
```swift
systemPrompt = """
    Вы - полезный ассистент с доступом к инструментам Yandex Tracker.
    ...
    """
```

**Стало:**
```swift
if settings.isYandexTrackerConfigured && yandexTrackerService.isConnected {
    systemPrompt = """
        Вы - полезный ассистент с доступом к инструментам Yandex Tracker.

        Когда пользователь спрашивает о задачах, используйте инструменты.
        Для обычных вопросов отвечайте как обычный ассистент.
        """
} else {
    systemPrompt = """
        Вы - полезный ассистент.

        Отвечайте на вопросы естественным языком.
        """
}
```

### 2. ChatViewModel.swift (строки 469-489)

Добавление инструментов в запрос:

```swift
// Добавляем инструменты Yandex Tracker если настроены
if settings.isYandexTrackerConfigured && yandexTrackerService.isConnected {
    let tools = YandexTrackerToolsProvider.getTools()
    let toolsJson = tools.map { tool in
        [
            "name": tool.name,
            "description": tool.description,
            "input_schema": [
                "type": "object",
                "properties": tool.input_schema.properties.mapValues { property in
                    ["type": property.type, "description": property.description]
                },
                "required": tool.input_schema.required ?? []
            ]
        ]
    }
    requestBody["tools"] = toolsJson
}
```

### 3. ChatViewModel.swift (строки 725-795)

Обработка tool_use:

```swift
private func handleToolUse(
    content: [[String: Any]],
    ...
) async {
    var toolResults: [[String: Any]] = []

    for contentItem in content {
        if contentItem["type"] as? String == "tool_use",
           let toolName = contentItem["name"] as? String,
           let toolInput = contentItem["input"] as? [String: Any] {

            // Выполняем инструмент
            let result = try await YandexTrackerToolsProvider.executeTool(
                name: toolName,
                input: toolInput,
                trackerService: yandexTrackerService
            )

            toolResults.append([
                "type": "tool_result",
                "tool_use_id": toolUseId,
                "content": result,
                "is_error": false
            ])
        }
    }

    // Отправляем результаты обратно Claude
    await sendToolResultsToClaude(toolResults: toolResults, ...)
}
```

### 4. Удалены устаревшие файлы

- `ChatViewModel+YandexTracker.swift` - больше не нужен (удалены `isYandexTrackerCommand` и `handleYandexTrackerCommand`)
- Ручная проверка ключевых слов больше не используется

---

## ✅ Преимущества новой реализации

| Аспект | Старая реализация | Новая реализация |
|--------|-------------------|------------------|
| **Распознавание команд** | `if contains("задач")` | Claude анализирует естественный язык |
| **Гибкость** | Только жёсткие ключевые слова | Любые формулировки |
| **Контекст** | ❌ Не учитывается | ✅ Полностью учитывается |
| **Форматирование** | Жёсткие шаблоны | Естественный язык от Claude |
| **Умность** | ❌ Простые if/contains | ✅ AI понимание |
| **Двойные ответы** | ❌ Были | ✅ Нет |
| **Упоминание Tracker** | ❌ Всегда | ✅ Только когда нужно |

---

## 🧪 Тестирование

### Тест 1: Обычный вопрос (Tracker НЕ настроен)

**Запрос:** "Привет, как дела?"

**Ожидание:**
- System prompt: "Вы - полезный ассистент"
- Нет tools в запросе
- Claude НЕ упоминает Tracker

**Результат:** ✅ Claude отвечает как обычный ассистент

---

### Тест 2: Вопрос о задачах (Tracker настроен)

**Запрос:** "Сколько открытых задач?"

**Ожидание:**
- System prompt: "...с доступом к Yandex Tracker"
- Tools добавлены в запрос
- Claude вызывает `get_yandex_tracker_stats`
- Результат отправляется обратно Claude
- Claude форматирует ответ естественным языком

**Результат:** ✅ Один правильный ответ с данными из Tracker

---

### Тест 3: Неоднозначный вопрос (Tracker настроен)

**Запрос:** "Много ли у меня работы?"

**Старая реализация:**
- ❌ Не распознано (нет слова "задач")
- Claude: "У меня нет доступа к календарю..."

**Новая реализация:**
- ✅ Claude понимает контекст
- Claude вызывает `get_yandex_tracker_stats`
- Claude: "Да, у вас довольно много работы! 10 открытых задач..."

---

### Тест 4: Обычный вопрос (Tracker настроен)

**Запрос:** "Объясни, что такое React?"

**Ожидание:**
- System prompt упоминает Tracker
- Tools добавлены
- Но Claude НЕ вызывает инструменты
- Claude отвечает как обычно

**Результат:** ✅ Claude правильно определяет, что инструменты не нужны

---

## 📊 Сравнение "до" и "после"

### ДО (ручная проверка):

```
Пользователь → [if contains("задач")] → MCP → Ответ
                         ↓
                     Claude (отдельно)
```

- ❌ Жёсткие ключевые слова
- ❌ Нет контекста
- ❌ Двойные ответы
- ❌ Claude всегда упоминает Tracker

### ПОСЛЕ (Tool Use API):

```
Пользователь → Claude (с tools) → tool_use → MCP → результат → Claude → Ответ
```

- ✅ AI понимание запросов
- ✅ Полный контекст
- ✅ Один правильный ответ
- ✅ Claude упоминает Tracker только когда нужно

---

## 🎯 Итого

### Что работает:

✅ Claude получает **все** запросы (не только non-Tracker)
✅ Инструменты добавляются **только** когда Tracker настроен
✅ System prompt **динамический** (упоминает Tracker только когда нужно)
✅ Claude **сам решает**, когда вызывать MCP инструменты
✅ Результаты отправляются **обратно Claude** для форматирования
✅ **Нет двойных ответов**
✅ **Нет лишних упоминаний Tracker**
✅ **Естественные ответы** от Claude

### Файлы:

- ✅ `ClaudeTool.swift` - модели для Tool Use API
- ✅ `YandexTrackerTools.swift` - определения инструментов
- ✅ `ChatViewModel.swift` - обработка tool_use
- ❌ `ChatViewModel+YandexTracker.swift` - удалён (больше не нужен)

### Сборка:

✅ **BUILD SUCCEEDED**

---

## 🚀 Готово к использованию!

Теперь Claude корректно работает с Yandex Tracker через Tool Use API:
- Понимает любые формулировки запросов
- Не упоминает Tracker когда не нужно
- Форматирует ответы естественным языком
- Учитывает контекст диалога

**Интеграция завершена! 🎉**
