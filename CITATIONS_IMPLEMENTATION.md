# Mandatory Citations Implementation - Подход 3 (Гибридный)

## ✅ Что реализовано

### 1. **Улучшенный промпт** (RAGService.swift:126-155)

Новый промпт требует:
- ✅ Маркеры `[Источник N]` после каждого утверждения
- ✅ Цитаты кода в блоках ```
- ✅ Секцию "Источники:" в конце ответа
- ✅ Указание файлов

**Ключевые инструкции в промпте:**
```
КРИТИЧЕСКИ ВАЖНО - ОБЯЗАТЕЛЬНЫЕ ТРЕБОВАНИЯ:
1. Используй ТОЛЬКО информацию из предоставленного контекста
2. ОБЯЗАТЕЛЬНО указывай [Источник N] после КАЖДОГО утверждения
3. Включай прямые цитаты кода в блоках ```
4. В конце ответа добавь секцию "Источники:" со списком файлов
5. Если информации нет - скажи это честно и НЕ придумывай
```

### 2. **Функция валидации** (RAGService.swift:209-236)

`validateCitations()` проверяет:
- ✅ **Маркеры источников**: `[Источник N]` или `[N]`
- ✅ **Секция "Источники:"**: Есть ли список в конце
- ✅ **Упоминания файлов**: `.swift`, `.md` и т.д.
- ✅ **Блоки кода**: ``` присутствуют

**Структура CitationValidation:**
```swift
struct CitationValidation {
    let hasSourceMarkers: Bool      // Есть ли [Источник N]
    let hasSourcesSection: Bool     // Есть ли секция "Источники:"
    let hasFileReferences: Bool     // Упоминаются ли файлы
    let hasCodeBlocks: Bool         // Есть ли блоки ```
    let citationCount: Int          // Количество цитат

    var isValid: Bool {
        // Минимум: маркеры + хотя бы 1 цитата
        return hasSourceMarkers && citationCount >= 1
    }

    var score: Double {
        // Качество от 0 до 1
        // 30% - маркеры, 30% - секция, 20% - файлы, 20% - код
    }
}
```

### 3. **Retry логика** (RAGService.swift:238-282)

`answerWithMandatoryCitations()` - основной метод:

**Алгоритм:**
1. Попытка 1: Получить ответ с улучшенным промптом
2. Валидация: Проверить наличие цитат
3. Если валидно → возвращаем результат ✅
4. Если нет → Попытка 2 (retry)
5. Если снова нет → Ошибка ❌

**Параметры:**
- `maxAttempts = 2` - максимум 2 попытки
- `rerankingStrategy = .threshold(0.5)` - используется reranking по умолчанию

**Логирование:**
```
🔍 RAG Citations: Attempt 1/2
📊 Citation validation: markers=true, count=3, sources=true
✅ RAG Citations: Valid! Citations found: 3
```

### 4. **CitationTestView.swift** (NEW - 354 строки)

Полноценный UI для тестирования на 5 вопросах:

**Функции:**
- ✅ Автоматический запуск 5 тестовых вопросов
- ✅ Progress bar во время тестирования
- ✅ Детальные результаты для каждого вопроса
- ✅ Сводная статистика (Success Rate, среднее цитат)
- ✅ Разворачиваемые карточки с ответами
- ✅ Цветовая индикация (зелёный = пройден, красный = не пройден)

**Тестовые вопросы:**
1. "Как работает векторный поиск?"
2. "Где сохраняются сообщения чата?"
3. "Какие MCP серверы поддерживаются?"
4. "Как реализована индексация документов?"
5. "Что делает EmbeddingService?"

### 5. **Интеграция в ContentView** (ContentView.swift:79-85)

Новая вкладка "Citations" с иконкой `quote.bubble.fill`

---

## 🧪 Как тестировать

### Шаг 1: Индексируйте код
```
1. Откройте tab "Search"
2. Укажите путь к проекту
3. Выберите файлы (Swift, Markdown)
4. Нажмите "Index Directory"
5. Дождитесь: "✅ X documents, Y chunks indexed"
```

### Шаг 2: Откройте вкладку Citations
```
1. Перейдите на tab "Citations"
2. Увидите информацию о тесте
3. Нажмите "Запустить тест на 5 вопросах"
```

### Шаг 3: Дождитесь результатов
```
Тест займёт ~1-2 минуты на 5 вопросов
(зависит от скорости API)

Progress bar покажет текущий прогресс:
"Тестирую вопрос 3 из 5"
```

### Шаг 4: Изучите результаты

**Сводка покажет:**
- ✅ **Пройдено**: 5/5 (или меньше)
- ✅ **Success Rate**: 100% (цель)
- ✅ **Среднее цитат**: 3.4 (должно быть >= 2)

**Детальные результаты:**
Для каждого вопроса:
- ✅/❌ Статус валидации
- 📊 Количество цитат
- ⏱ Время обработки
- 🎯 Качество (0-100%)
- 📝 Полный ответ (разворачивается)

---

## 📊 Метрики оценки

### 1. Citation Rate
```
Citation Rate = Ответов с цитатами / Всего ответов

Цель: 100% (5/5)
Минимум: 80% (4/5)
```

### 2. Average Citations per Answer
```
Среднее = Сумма всех цитат / Количество ответов

Цель: >= 3 цитат на ответ
Хорошо: >= 2 цитат
Плохо: < 2 цитат
```

### 3. Citation Quality Score
```
Quality = (markers*0.3 + section*0.3 + files*0.2 + code*0.2) * 100%

Отлично: >= 80%
Хорошо: >= 60%
Плохо: < 60%
```

### 4. Hallucination Rate (ручная проверка)

**Как проверить:**
1. Прочитайте ответ
2. Найдите каждый [Источник N]
3. Откройте указанный файл
4. Проверьте, правда ли там эта информация

**Галлюцинация** = Факт в ответе, которого нет в источнике

```
Hallucination Rate = Галлюцинаций / Всего утверждений

Цель: 0% (нет галлюцинаций)
Допустимо: <= 10%
```

---

## 📈 Ожидаемые результаты

### До внедрения (baseline):
```
Вопрос: "Как работает векторный поиск?"

Ответ:
"Векторный поиск использует эмбеддинги для поиска похожих документов.
Он работает на основе cosine similarity и возвращает топ-K результатов."

❌ Нет ссылок на источники
❌ Нет указания файлов
❌ Невозможно проверить правдивость
❌ Может содержать галлюцинации
```

### После внедрения (с Citations):
```
Вопрос: "Как работает векторный поиск?"

Ответ:
"Векторный поиск реализован в классе VectorSearchService [Источник 1].

Основной метод search(query:topK:) [Источник 1] выполняет следующие шаги:

1. Создаёт эмбеддинг для query через EmbeddingService [Источник 2]:
```swift
let queryEmbedding = try await embeddingService.embed(text: query)
```

2. Вычисляет cosine similarity с каждым чанком [Источник 1]:
```swift
let similarity = cosineSimilarity(queryEmbedding, chunkEmbedding)
```

3. Сортирует результаты по similarity и возвращает топ-K [Источник 1].

Источники:
[1] VectorSearchService.swift - реализация векторного поиска
[2] EmbeddingService.swift - создание эмбеддингов"

✅ Есть ссылки [Источник 1], [Источник 2]
✅ Указаны файлы (VectorSearchService.swift)
✅ Есть цитаты кода
✅ Есть секция "Источники:"
✅ Можно проверить каждый факт
```

---

## 🎯 Критерии успеха

### Обязательные (Must Have):
- ✅ **100% ответов содержат маркеры источников** `[Источник N]`
- ✅ **100% ответов содержат секцию "Источники:"**
- ✅ **Среднее >= 2 цитат на ответ**

### Желательные (Should Have):
- ✅ **80%+ ответов содержат упоминания файлов**
- ✅ **60%+ ответов содержат блоки кода**
- ✅ **Quality Score >= 70%**

### Дополнительные (Nice to Have):
- ✅ **Hallucination Rate < 10%**
- ✅ **Retry понадобился в < 20% случаев**
- ✅ **Processing time < 5s на запрос**

---

## 🐛 Troubleshooting

### Проблема: "Нет цитат в ответе"

**Причины:**
1. Модель игнорирует промпт
2. Контекст слишком большой
3. Вопрос слишком общий

**Решение:**
- Retry логика сработает автоматически
- Если оба раза failed - проверьте промпт
- Убедитесь что индекс не пустой

### Проблема: "Цитаты есть, но файлы неправильные"

**Причины:**
1. Модель галлюцинирует файлы
2. Файлы были в контексте, но не в топ-K

**Решение:**
- Это галлюцинация - нужна ручная проверка
- Можно увеличить topK до 10
- Использовать reranking для лучшего контекста

### Проблема: "Success Rate < 80%"

**Причины:**
1. Промпт недостаточно строгий
2. maxAttempts = 2 недостаточно
3. Качество контекста низкое

**Решение:**
- Увеличить maxAttempts до 3
- Использовать LLM-based reranking
- Улучшить промпт (добавить примеры)

---

## 🔄 Как улучшить дальше

### 1. Structured Output (JSON)
```swift
struct CitedAnswer: Codable {
    let answer: String
    let citations: [Citation]

    struct Citation: Codable {
        let sourceIndex: Int
        let fileName: String
        let quote: String
    }
}
```

### 2. Clickable Citations в UI
```swift
// Сделать [Источник 1] кликабельными
// По клику - открыть файл в Xcode на нужной строке
```

### 3. Citation Highlighting
```swift
// Подсветить цитаты разными цветами
// [Источник 1] - синий
// [Источник 2] - зелёный
```

### 4. Automatic Verification
```swift
// Автоматически проверять:
// - Существует ли файл?
// - Есть ли цитата в файле?
// - Правильные ли строки указаны?
```

---

## 📝 Файлы изменены

### Modified:
1. **RAGService.swift**
   - Обновлён промпт `buildRAGPrompt()`
   - Добавлена `validateCitations()`
   - Добавлена `answerWithMandatoryCitations()`
   - Добавлена структура `CitationValidation`

2. **ChatViewModel.swift**
   - Добавлен метод `testCitationQuestion()`

3. **ContentView.swift**
   - Добавлена вкладка "Citations"

### Created:
4. **CitationTestView.swift** (NEW)
   - Полный UI для тестирования
   - 5 тестовых вопросов
   - Автоматическая валидация
   - Детальная статистика

5. **CITATIONS_IMPLEMENTATION.md** (этот файл)

---

## ✅ Готово к тестированию!

Запустите приложение и перейдите на вкладку **Citations** для автоматического тестирования на 5 вопросах.

Результаты покажут:
- ✅ Сколько ответов прошли валидацию
- 📊 Среднее количество цитат
- 🎯 Quality Score для каждого ответа
- 📝 Полные ответы с цитатами

**Цель:** 100% Success Rate (5/5) 🎯
