# Вкладка MCP в приложении

## ✅ Что добавлено

Новая вкладка **MCP** в основном приложении для работы с MCP серверами!

### Расположение:
```
Чат → Multi-Agent → MCP (новая!)
```

---

## 🎯 Возможности вкладки MCP

### 1. **Подключение к серверам**
- Ввод команды и аргументов
- Статус подключения в реальном времени
- Автоматическое определение путей (npx из nvm)
- Отображение количества доступных инструментов

### 2. **Быстрый выбор популярных серверов**
Предустановленные серверы в один клик:
- **Memory** - Key-value хранилище
- **Filesystem** - Работа с файлами
- **Fetch** - HTTP запросы
- **GitHub** - Интеграция с GitHub

### 3. **Просмотр инструментов**
- Список всех доступных tools от сервера
- Название и описание каждого инструмента
- Красивые карточки с иконками

### 4. **Вызов инструментов**
- Клик на инструмент открывает форму вызова
- Ввод аргументов в JSON формате
- Выполнение и отображение результата
- Обработка ошибок

---

## 📱 Интерфейс

### Главный экран (отключен):

```
┌─────────────────────────────────────┐
│ MCP Серверы                          │
├─────────────────────────────────────┤
│                                      │
│ 🔘 Подключение                      │
│ ○ Не подключено                      │
│                                      │
│ Команда:                             │
│ [npx                              ]  │
│                                      │
│ Аргументы:                           │
│ [-y,@modelcontextprotocol/server-...│
│                                      │
│ [   Подключиться   ]                │
│                                      │
├─────────────────────────────────────┤
│                                      │
│ ⭐ Быстрый выбор                    │
│                                      │
│ 🧠 Memory                            │
│    Key-value хранилище           →  │
│                                      │
│ 📁 Filesystem                        │
│    Работа с файлами              →  │
│                                      │
│ 🌐 Fetch                             │
│    HTTP запросы                  →  │
│                                      │
│ </> GitHub                           │
│    Работа с GitHub               →  │
│                                      │
└─────────────────────────────────────┘
```

### Главный экран (подключен):

```
┌─────────────────────────────────────┐
│ MCP Серверы        [Отключиться]    │
├─────────────────────────────────────┤
│                                      │
│ 🔘 Подключение                      │
│ ● Подключено                         │
│                                      │
│ Инструментов: 2    [Обновить]       │
│                                      │
├─────────────────────────────────────┤
│                                      │
│ 🔧 Доступные инструменты            │
│                                      │
│ 🔨 store_memory                  →  │
│    Store a value in memory           │
│                                      │
│ 🔨 retrieve_memory               →  │
│    Retrieve a value from memory      │
│                                      │
└─────────────────────────────────────┘
```

### Вызов инструмента (sheet):

```
┌─────────────────────────────────────┐
│ [Закрыть]  Вызов инструмента        │
├─────────────────────────────────────┤
│                                      │
│ Инструмент                           │
│ Имя: store_memory                    │
│ Описание: Store a value in memory   │
│                                      │
│ Аргументы (JSON)                     │
│ ┌─────────────────────────────────┐ │
│ │{                                │ │
│ │  "key": "test",                 │ │
│ │  "value": "Hello MCP!"          │ │
│ │}                                │ │
│ └─────────────────────────────────┘ │
│                                      │
│ [        Выполнить        ]         │
│                                      │
│ Результат                            │
│ ┌─────────────────────────────────┐ │
│ │Content 1:                       │ │
│ │Successfully stored value        │ │
│ └─────────────────────────────────┘ │
│                                      │
└─────────────────────────────────────┘
```

---

## 🚀 Как использовать

### Быстрый старт:

1. **Откройте вкладку MCP**
   - Нажмите на иконку сети в нижнем TabBar

2. **Выберите сервер**
   - Кликните на любой из предустановленных серверов
   - Или введите свою команду

3. **Подключитесь**
   - Нажмите "Подключиться"
   - Дождитесь статуса "Подключено"

4. **Используйте инструменты**
   - Кликните на любой инструмент
   - Введите аргументы в JSON
   - Нажмите "Выполнить"

### Пример: Memory Server

```
1. Выберите "Memory" из быстрого выбора
2. Подключитесь
3. Кликните на "store_memory"
4. Введите аргументы:
   {
     "key": "greeting",
     "value": "Hello from MCP!"
   }
5. Выполните
6. Кликните на "retrieve_memory"
7. Введите:
   {
     "key": "greeting"
   }
8. Увидите: "Hello from MCP!"
```

---

## 🔧 Технические детали

### Архитектура:

```
MCPView (SwiftUI)
    ↓
MCPService (@StateObject)
    ↓
MCP Swift SDK Client
    ↓
Process (subprocess)
    ↓
MCP Server (Node.js)
```

### Компоненты:

1. **MCPView.swift** - главный view вкладки
2. **MCPService.swift** - бизнес-логика
3. **ToolCard** - карточка инструмента
4. **ServerPresetCard** - карточка предустановленного сервера
5. **ToolCallView** - sheet для вызова инструмента

### Состояния:

- `isConnecting: Bool` - идет подключение
- `mcpService.isConnected: Bool` - подключен к серверу
- `mcpService.availableTools: [MCPTool]` - список инструментов
- `mcpService.errorMessage: String?` - ошибка если есть
- `selectedTool: MCPTool?` - выбранный инструмент
- `showToolCallSheet: Bool` - показывать форму вызова

---

## 📝 Добавление своих серверов

### Вариант 1: Через UI
Просто введите команду и аргументы вручную:
```
Команда: npx
Аргументы: -y,@modelcontextprotocol/server-sqlite,/path/to/db.sqlite
```

### Вариант 2: Добавить в popularServers

Отредактируйте `MCPView.swift`:

```swift
let popularServers: [ServerPreset] = [
    // ... существующие ...

    ServerPreset(
        name: "SQLite",
        description: "Работа с базами данных",
        command: "npx",
        args: "-y,@modelcontextprotocol/server-sqlite,/path/to/db.sqlite",
        icon: "cylinder.fill",
        color: .orange
    ),
]
```

---

## 🎨 Особенности дизайна

### Адаптивность:
- ✅ Работает на macOS
- ✅ Responsive layout
- ✅ Поддержка темной темы

### UX:
- ✅ Индикаторы загрузки
- ✅ Цветовые статусы (зеленый = подключен)
- ✅ Иконки для каждого типа сервера
- ✅ Плавные анимации
- ✅ Sheets для модальных окон
- ✅ Копирование результатов

### Обработка ошибок:
- ✅ Отображение ошибок подключения
- ✅ Ошибки выполнения инструментов
- ✅ Graceful degradation

---

## 🐛 Известные ограничения

### 1. Парсинг JSON аргументов
Сейчас в `ToolCallView` аргументы не парсятся:
```swift
// TODO: Parse JSON and convert to [String: Value]
let toolResult = try await mcpService.callTool(name: tool.name, arguments: nil)
```

**Решение:** Нужно добавить JSON парсер для конвертации в `[String: Value]`

### 2. Отображение schema
InputSchema инструментов не отображается в UI

**Решение:** Можно добавить раздел "Schema" в `ToolCallView`

### 3. Множественные подключения
Пока можно подключиться только к одному серверу

**Решение:** Добавить управление несколькими `MCPService`

---

## 🔮 Будущие улучшения

### Возможные фичи:

1. **История вызовов**
   - Сохранение последних вызовов
   - Повторный вызов одним кликом

2. **Избранные серверы**
   - Сохранение своих серверов
   - Быстрый доступ

3. **Экспорт результатов**
   - Сохранение в файл
   - Копирование в буфер обмена

4. **JSON Schema validation**
   - Валидация аргументов перед вызовом
   - Автозаполнение по schema

5. **Множественные подключения**
   - TabView для разных серверов
   - Переключение между серверами

6. **Интеграция с Чатом**
   - Использование MCP инструментов в чате
   - AI выбирает нужные tools

---

## 📖 Документация

- **MCP_TAB_GUIDE.md** - этот файл (руководство по вкладке)
- **README_MCP.md** - общее введение в MCP
- **MCP_QUICKSTART.md** - быстрый старт
- **MCP_SUMMARY.md** - архитектура клиента
- **FINAL_SOLUTION.md** - решение всех проблем

---

**Готово! Теперь у вас есть полноценная вкладка для работы с MCP прямо в приложении! 🎉**
